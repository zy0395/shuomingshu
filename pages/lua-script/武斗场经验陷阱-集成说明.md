# 武斗场经验陷阱脚本 - 集成说明

## 一、功能说明

这个脚本实现了简单但完整的"踩陷阱加经验"玩法：

- 玩家走到指定坐标时，每5秒自动获得一次经验
- 支持多个经验点，每个点可以设置不同的经验值
- 支持"普通区"和"抢点区"等不同类型的经验点
- 自动防止刷屏（5秒CD）
- 内存安全（定期清理计时器）

## 二、如何集成到现有脚本系统

### 方法1：直接在玩家执行事件中添加

编辑文件：`bin\Debug\net8.0-windows\Database\System\lua\事件脚本\玩家事件模块\玩家执行事件.lua`

在文件末尾添加以下代码：

```lua
-- 加载武斗场经验陷阱模块
local 武斗场模块路径 = "Database/System/lua/功能模块/武斗场经验陷阱.lua"
local 武斗场模块已加载, 武斗场模块 = pcall(dofile, 武斗场模块路径)

-- 修改 处理玩家执行事件 函数
local 原处理函数 = 处理玩家执行事件

function 处理玩家执行事件(玩家)
    -- 先执行原有逻辑
    if 原处理函数 then
        原处理函数(玩家)
    end
    
    -- 执行武斗场经验检测
    if 武斗场模块已加载 and 处理武斗场经验 then
        处理武斗场经验(玩家)
    end
end
```

### 方法2：作为独立功能模块

1. 将 `武斗场经验陷阱示例.lua` 复制到：
   ```
   bin\Debug\net8.0-windows\Database\System\lua\功能模块\武斗场经验陷阱.lua
   ```

2. 在 `玩家执行事件.lua` 顶部添加：
   ```lua
   dofile("Database/System/lua/功能模块/武斗场经验陷阱.lua")
   ```

3. 在 `处理玩家执行事件` 函数中调用：
   ```lua
   function 处理玩家执行事件(玩家)
       -- ... 其他逻辑 ...
       
       处理武斗场经验(玩家)
   end
   ```

## 三、自定义配置

### 修改地图ID

```lua
local 武斗场地图ID = 183  -- 改成你的武斗场地图编号
```

### 添加更多经验点

```lua
-- 方法1：直接在列表中添加
{X = 150, Y = 150, 经验值 = 1000, 类型 = "高级"},

-- 方法2：使用辅助函数添加单个点
添加经验点(100, 100, 500, "普通")

-- 方法3：批量添加一片区域
添加经验区域(50, 50, 60, 60, 1000, "高级区")  -- 从(50,50)到(60,60)的矩形区域
```

### 调整经验获取间隔

```lua
-- 将这一行改成你想要的秒数
if 当前时间 - 上次时间 >= 5 then  -- 5秒改成你想要的数值
```

## 四、进阶功能扩展

### 1. 添加时间段限制

```lua
-- 在 检查经验点 函数开头添加
local 当前小时 = tonumber(os.date("%H"))
if 当前小时 < 13 or 当前小时 >= 14 then
    return  -- 只在13:00-14:00开放
end
```

### 2. 添加等级限制

```lua
-- 在给经验前检查
if 玩家.当前等级 < 30 then
    玩家:发送系统消息("需要30级才能获得武斗场经验")
    return
end
```

### 3. 添加特效或提示

```lua
-- 在给经验后添加
玩家:发送系统消息("获得经验：" .. 经验点.经验值)
-- 或者用其他方式发送公告、特效等
```

### 4. 记录统计数据

```lua
-- 添加全局统计
local 经验统计 = {}

-- 在给经验时
经验统计[玩家名字] = (经验统计[玩家名字] or 0) + 经验点.经验值
```

## 五、优势说明

相比之前的C#硬编码方式，脚本方案有以下优势：

1. **热更新**：修改脚本后重载即可生效，不需要重启服务器
2. **灵活配置**：经验值、坐标、时间段等都可以随时调整
3. **易于扩展**：可以轻松添加新功能（等级限制、VIP加成、活动时间等）
4. **多地图复用**：同样的逻辑可以用在其他地图
5. **维护简单**：不用改C#代码，运维人员也能调参数

## 六、性能说明

这个脚本每个在线玩家每帧执行一次（大约每秒30-60次），但实际计算很轻量：

- 只检查当前地图是否匹配（1次比较）
- 只遍历经验点列表（通常10-20个点）
- 只在匹配时才访问计时器

对于100人同时在线的武斗场，性能影响可以忽略不计。

## 七、注意事项

1. 确保 `玩家:玩家增加经验` 方法在 Lua 中已经注册（从你的grep结果看是有的）
2. 坐标必须精确匹配，玩家必须正好站在那个格子上
3. 如果想要"范围内就加经验"，需要改成距离判断而不是坐标完全匹配
4. 计时器用的是 `os.time()`（秒级），如果需要更精确的控制可以改用游戏时间
