-- ========================================
-- 武斗场经验陷阱脚本示例
-- ========================================
-- 功能：玩家走到指定坐标时自动获得经验
-- 使用方式：将此脚本加入到 玩家执行事件.lua 中调用
-- ========================================

-- 武斗场地图编号
local 武斗场地图ID = 183

-- 经验点配置
local 经验点列表 = {
    -- 普通经验点（每5秒给500经验）
    {X = 100, Y = 100, 经验值 = 500, 类型 = "普通"},
    {X = 110, Y = 100, 经验值 = 500, 类型 = "普通"},
    {X = 120, Y = 100, 经验值 = 500, 类型 = "普通"},
    {X = 130, Y = 100, 经验值 = 500, 类型 = "普通"},
    
    -- 抢点区域（每5秒给2500经验）
    {X = 115, Y = 115, 经验值 = 2500, 类型 = "抢点"},
    {X = 116, Y = 115, 经验值 = 2500, 类型 = "抢点"},
    {X = 115, Y = 116, 经验值 = 2500, 类型 = "抢点"},
    {X = 116, Y = 116, 经验值 = 2500, 类型 = "抢点"},
}

-- 玩家经验计时器（存储每个玩家上次获得经验的时间）
local 玩家经验计时 = {}

-- 检查玩家是否在经验点上
local function 检查经验点(玩家)
    -- 检查地图
    if not 玩家 or not 玩家.当前地图 or 玩家.当前地图.地图编号 ~= 武斗场地图ID then
        return
    end
    
    -- 获取玩家坐标
    local 玩家坐标 = 玩家.当前坐标
    local 玩家名字 = 玩家.对象名字
    
    -- 检查是否在任何经验点上
    for _, 经验点 in ipairs(经验点列表) do
        if 玩家坐标.X == 经验点.X and 玩家坐标.Y == 经验点.Y then
            -- 获取玩家上次领取经验的时间
            local 上次时间 = 玩家经验计时[玩家名字] or 0
            local 当前时间 = os.time()
            
            -- 每5秒才能领取一次经验
            if 当前时间 - 上次时间 >= 5 then
                -- 给玩家增加经验
                玩家:玩家增加经验(nil, 经验点.经验值)
                
                -- 更新计时器
                玩家经验计时[玩家名字] = 当前时间
                
                -- 可选：发送提示消息
                -- 玩家:发送系统消息("获得经验：" .. 经验点.经验值 .. " (" .. 经验点.类型 .. ")")
            end
            
            return
        end
    end
end

-- 清理离线玩家的计时器（防止内存泄漏）
local 清理计时器间隔 = 300 -- 5分钟清理一次
local 上次清理时间 = os.time()

local function 清理离线玩家计时器()
    local 当前时间 = os.time()
    if 当前时间 - 上次清理时间 >= 清理计时器间隔 then
        -- 这里可以添加清理逻辑，或者依赖自然的垃圾回收
        上次清理时间 = 当前时间
    end
end

-- ========================================
-- 主处理函数（在玩家执行事件中调用）
-- ========================================
function 处理武斗场经验(玩家)
    检查经验点(玩家)
    清理离线玩家计时器()
end

-- ========================================
-- 辅助函数：动态添加经验点
-- ========================================
function 添加经验点(X, Y, 经验值, 类型)
    table.insert(经验点列表, {
        X = X,
        Y = Y,
        经验值 = 经验值,
        类型 = 类型 or "普通"
    })
end

-- ========================================
-- 辅助函数：清空所有经验点
-- ========================================
function 清空经验点()
    经验点列表 = {}
end

-- ========================================
-- 辅助函数：批量添加一片区域的经验点
-- ========================================
function 添加经验区域(起始X, 起始Y, 结束X, 结束Y, 经验值, 类型)
    for x = 起始X, 结束X do
        for y = 起始Y, 结束Y do
            添加经验点(x, y, 经验值, 类型)
        end
    end
end

-- 使用示例：
-- 添加经验点(100, 100, 500, "普通")
-- 添加经验区域(50, 50, 60, 60, 1000, "高级区")
