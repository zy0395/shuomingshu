<!DOCTYPE html>
<html lang='zh-CN'>
<head><meta charset='UTF-8'><title>Lua脚本教程</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Microsoft YaHei',Arial;padding:40px;background:#0f1419;line-height:1.8;color:#e2e8f0}
h1{color:#667eea;border-bottom:3px solid #667eea;padding-bottom:15px;margin-bottom:30px;font-size:2.2em}
h2{color:#f6ad55;margin:40px 0 20px;padding-left:15px;border-left:5px solid #f6ad55;font-size:1.6em}
h3{color:#667eea;margin:30px 0 15px;font-size:1.3em}
h4{color:#68d391;margin:20px 0 10px;font-size:1.1em}
.intro{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#e2e8f0;padding:25px;margin:25px 0;border-radius:10px}
.info-box{background:#1a1f2e;border-left:4px solid #667eea;padding:20px;margin:25px 0;border-radius:4px;color:#a0aec0}
.warning-box{background:#1a1f2e;border-left:4px solid #f6ad55;padding:20px;margin:25px 0;border-radius:4px;color:#a0aec0}
.success-box{background:#1a1f2e;border-left:4px solid #68d391;padding:20px;margin:25px 0;border-radius:4px;color:#a0aec0}
pre{background:#1a1f2e;color:#abb2bf;padding:20px;margin:20px 0;border-radius:8px;font-family:Consolas,Monaco,monospace;font-size:14px;line-height:1.6;overflow-x:auto;border:1px solid #2d3748}
code{background:#1a1f2e;color:#667eea;padding:2px 6px;border-radius:3px;font-family:Consolas,monospace}
ul,ol{margin-left:30px;margin-top:10px;color:#a0aec0}
li{margin:8px 0}
table{width:100%;border-collapse:collapse;margin:20px 0}
th,td{border:1px solid #2d3748;padding:10px 12px;text-align:left}
th{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;font-size:0.95em}
td{background:#1a1f2e;color:#a0aec0;font-size:0.9em}
tr:hover td{background:#1f2633}
.feature-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin:25px 0}
.feature-card{background:#1a1f2e;padding:20px;border-radius:8px;border:1px solid #2d3748;transition:all 0.3s}
.feature-card:hover{border-color:#667eea;background:#1f2633;transform:translateY(-3px)}
.feature-card h4{color:#667eea;margin-bottom:10px}
.feature-card p{color:#a0aec0;font-size:0.95em;line-height:1.6}
strong{color:#f6ad55}
p{margin:10px 0;color:#a0aec0}
.quick-ref{background:#1a1f2e;padding:15px 20px;border-radius:8px;border:1px solid #667eea;margin:15px 0}
.quick-ref code{background:#0f1419;padding:4px 8px}
</style>
</head>
<body>
<h1>🌙 Lua脚本开发教程</h1>
<div class='intro'>
<p><strong>🎯 三句话说明 Lua 脚本系统</strong></p>
<p>1️⃣ <strong>脚本放哪？</strong> → <code>Database/System/lua/事件脚本/</code> 目录下，按模块分好文件夹</p>
<p>2️⃣ <strong>怎么写？</strong> → 实现 <code>处理XXX事件(玩家, ...)</code> 函数，里面用 <code>玩家:执行脚本命令(...)</code> 调用 TXT 命令</p>
<p>3️⃣ <strong>核心能力</strong> → 可以直接复用所有 TXT 脚本命令，还能用 if/for 做复杂逻辑</p>
</div>

<h2>✨ NwServer Lua 脚本系统特性</h2>

<div class='feature-grid'>
<div class='feature-card'><h4>🌐 完整中文化</h4><p>函数名、变量名、事件名全部支持中文，如 <code>处理玩家进入游戏</code>、<code>玩家.对象名字</code>，降低学习门槛</p></div>
<div class='feature-card'><h4>🔗 TXT 命令复用</h4><p>通过 <code>执行脚本命令</code> 直接调用 300+ TXT 脚本命令，无需重复开发，行为与 TXT 脚本完全一致</p></div>
<div class='feature-card'><h4>📦 事件驱动架构</h4><p>50+ 游戏事件自动分发到 Lua，脚本只需实现 <code>处理XXX事件</code> 函数，无需关心底层调用</p></div>
<div class='feature-card'><h4>🛡️ 安全可控</h4><p>C# 控制暴露哪些对象和方法给 Lua，脚本无法随意访问底层代码，保护服务器稳定性</p></div>
<div class='feature-card'><h4>🧩 双脚本共存</h4><p>Lua 和 TXT 脚本可以混合使用，简单逻辑用 TXT，复杂逻辑用 Lua，各取所长</p></div>
<div class='feature-card'><h4>🔄 热重载支持</h4><p>修改 Lua 脚本后可热重载，无需重启服务器（通过 <code>reload</code> 事件）</p></div>
</div>

<h2>🆚 MoonSharp vs NLua 对比</h2>

<div class='info-box'><strong>💡 为什么选择 MoonSharp？</strong>
<p>NwServer 使用 <strong>MoonSharp</strong> 作为 Lua 引擎，而非 NLua。两者各有优劣，MoonSharp 更适合本项目的设计目标。</p>
</div>

<table>
<thead><tr><th style='width:20%'>对比项</th><th style='width:40%'>MoonSharp（本项目使用）</th><th style='width:40%'>NLua</th></tr></thead>
<tbody>
<tr><td><strong>实现方式</strong></td><td>纯 C# 实现，无原生依赖</td><td>封装原生 Lua DLL（如 lua54.dll）</td></tr>
<tr><td><strong>部署难度</strong></td><td>✅ 简单，无需额外 DLL</td><td>⚠️ 需要携带 Lua DLL，平台兼容性问题</td></tr>
<tr><td><strong>中文标识符</strong></td><td>✅ 完美支持中文函数名/变量名</td><td>❌ 不支持中文标识符</td></tr>
<tr><td><strong>C# 类型访问</strong></td><td>⚠️ 需预先注册类型（<code>UserData.RegisterType</code>）</td><td>✅ 可通过 <code>luanet.import_type</code> 动态导入任意类型</td></tr>
<tr><td><strong>脚本自由度</strong></td><td>⚠️ 受限于 C# 暴露的 API</td><td>✅ 脚本可直接访问几乎所有 C# 类型</td></tr>
<tr><td><strong>安全性</strong></td><td>✅ C# 完全控制暴露范围，脚本无法越权</td><td>⚠️ 脚本权限过大，容易误操作底层数据</td></tr>
<tr><td><strong>维护性</strong></td><td>✅ 脚本与 C# 解耦，重构 C# 不影响脚本</td><td>⚠️ 脚本依赖 C# 类型细节，重构代价大</td></tr>
<tr><td><strong>Lua 版本</strong></td><td>Lua 5.2 兼容</td><td>Lua 5.4（可选其他版本）</td></tr>
<tr><td><strong>性能</strong></td><td>⚠️ 纯托管，略慢于原生</td><td>✅ 原生 Lua VM，性能更好</td></tr>
<tr><td><strong>项目维护</strong></td><td>⚠️ 作者更新较少（但稳定）</td><td>✅ 社区活跃</td></tr>
</tbody>
</table>

<h3>📌 MoonSharp 的优势（为什么适合本项目）</h3>
<div class='success-box'>
<ul>
<li><strong>中文化友好</strong> → 函数名 <code>处理玩家进入游戏</code>、属性 <code>玩家.对象名字</code> 都能用中文，降低非程序员的学习成本</li>
<li><strong>安全可控</strong> → 脚本只能调用你暴露的 API，不会误改底层数据结构，服务器更稳定</li>
<li><strong>部署简单</strong> → 纯 C# 实现，不需要带 lua54.dll，跨平台无忧</li>
<li><strong>TXT 命令复用</strong> → 通过统一接口调用 300+ TXT 命令，脚本作者无需学习新 API</li>
<li><strong>适合"配置式脚本"</strong> → 本项目的设计目标是让脚本更像"高级配置"，而非"另一个编程语言"</li>
</ul>
</div>

<h3>📌 MoonSharp 的不足（坦诚说明）</h3>
<div class='warning-box'>
<ul>
<li><strong>灵活性受限</strong> → 不能像 NLua 那样在脚本里随便 <code>import_type</code> 导入 C# 类型，必须 C# 预先注册</li>
<li><strong>新增功能需改代码</strong> → 如果脚本需要访问新的 C# 对象/方法，必须在 C# 里添加注册代码</li>
<li><strong>Lua 5.2</strong> → 不支持 Lua 5.3/5.4 的新特性（如整数位运算语法），但对游戏脚本影响极小</li>
<li><strong>作者更新慢</strong> → MoonSharp 近年更新较少，但已足够稳定，功能够用</li>
</ul>
</div>

<h3>📌 NLua 的 "自由度" 其实是双刃剑</h3>
<div class='info-box'>
<p>有人建议切换到 NLua，理由是"可以在脚本里直接 import 任意 C# 类型，更灵活"。但这种自由度也带来风险：</p>
<pre>-- NLua 风格（看起来很灵活）
local Player = luanet.import_type("游戏服务器.实例类.玩家实例")
local item = Player.背包[0]  -- 直接访问内部数据结构
item.数量 = 999              -- 随便改？可能破坏数据一致性！

-- MoonSharp 风格（受控但安全）
玩家:执行脚本命令("发放指定物品", "屠龙", 1)  -- 走正规流程，有校验
</pre>
<p><strong>结论：</strong>对于游戏服务器这种需要稳定性的项目，"受控的 API" 比 "随意访问底层" 更合适。</p>
</div>

<h2>🚀 快速开始：核心 API（最常用）</h2>

<div class='success-box'><strong>⭐ 记住这 4 个函数，就能完成 90% 的脚本工作</strong></div>

<h3>1️⃣ 执行 TXT 操作命令</h3>
<div class='quick-ref'>
<code>玩家:执行脚本命令("命令名称", 参数1, 参数2, ...)</code>
</div>
<pre>-- 常用示例
玩家:执行脚本命令("发送系统消息", "★ 欢迎来到游戏世界！★")
玩家:执行脚本命令("传送指定地图", 3, 330, 330, 0)
玩家:执行脚本命令("发放指定物品", "屠龙", 1)
玩家:执行脚本命令("调整角色金币", "+", 10000)
玩家:执行脚本命令("发送全服公告", "公告内容", "false")</pre>

<h3>2️⃣ 执行 TXT 检测命令（返回 true/false）</h3>
<div class='quick-ref'>
<code>玩家:执行脚本检测("检测命令", 参数1, 参数2, ...)</code>
</div>
<pre>-- 常用示例
if 玩家:执行脚本检测("检测角色等级", ">=", "50") then
    -- 等级大于等于 50
end

if 玩家:执行脚本检测("检测金币数量", ">=", "10000") then
    -- 金币足够
end

if 玩家:执行脚本检测("检测背包物品", "屠龙", "1") then
    -- 背包中有屠龙
end</pre>

<h3>3️⃣ 获取 TXT 脚本变量</h3>
<div class='quick-ref'>
<code>玩家:获取脚本变量("变量表达式")</code> → 返回字符串
</div>
<pre>-- 变量类型：%G0~%G999（个人永久）、%U0~%U999（临时）、%A0~%A999（全局）
local 积分 = tonumber(玩家:获取脚本变量("%G10")) or 0
local 临时值 = tonumber(玩家:获取脚本变量("%U5")) or 0

-- 设置变量用操作命令
玩家:执行脚本命令("变量运算", "%G10", "=", 100)   -- 赋值
玩家:执行脚本命令("变量运算", "%G10", "+", 50)    -- 加</pre>

<h3>4️⃣ 获取 TXT 脚本常量</h3>
<div class='quick-ref'>
<code>玩家:获取脚本常量("常量标签")</code> → 返回字符串
</div>
<pre>-- 常用常量
local 玩家名 = 玩家:获取脚本常量("&lt;$角色名称&gt;")
local 等级 = 玩家:获取脚本常量("&lt;$角色等级&gt;")
local 在线人数 = 玩家:获取脚本常量("&lt;$玩家数量&gt;")</pre>

<h2>📦 玩家对象常用属性</h2>
<table>
<thead><tr><th style='width:30%'>属性</th><th style='width:35%'>说明</th><th style='width:35%'>示例</th></tr></thead>
<tbody>
<tr><td><code>玩家.对象名字</code></td><td>角色名称</td><td><code>local 名字 = 玩家.对象名字</code></td></tr>
<tr><td><code>玩家.当前等级</code></td><td>当前等级</td><td><code>if 玩家.当前等级 >= 50 then</code></td></tr>
<tr><td><code>玩家.角色金币</code></td><td>金币数量</td><td><code>local 金币 = 玩家.角色金币</code></td></tr>
<tr><td><code>玩家.角色元宝</code></td><td>元宝数量</td><td><code>local 元宝 = 玩家.角色元宝</code></td></tr>
<tr><td><code>玩家.角色职业</code></td><td>0=战士，1=法师，2=道士</td><td><code>if 玩家.角色职业 == 0 then</code></td></tr>
<tr><td><code>玩家.当前地图</code></td><td>所在地图编号</td><td><code>if 玩家.当前地图 == 3 then</code></td></tr>
<tr><td><code>玩家.当前坐标.X</code></td><td>X 坐标</td><td><code>local x = 玩家.当前坐标.X</code></td></tr>
<tr><td><code>玩家.当前坐标.Y</code></td><td>Y 坐标</td><td><code>local y = 玩家.当前坐标.Y</code></td></tr>
</tbody>
</table>
<h2>� 完整事件函数清单（重点！）</h2>

<div class='info-box'><strong>💡 事件系统原理</strong>
<p>当游戏中发生特定事件时，服务器会自动调用 Lua 中对应的事件处理函数。脚本作者只需实现 <code>处理XXX事件</code> 函数即可。</p>
</div>

<h3>🎮 玩家事件（角色生命周期）</h3>
<table>
<thead><tr><th style='width:22%'>C# 调用的函数</th><th style='width:25%'>你要实现的函数</th><th style='width:25%'>参数</th><th style='width:28%'>脚本文件</th></tr></thead>
<tbody>
<tr><td><code>玩家进入游戏</code></td><td><code>处理玩家进入游戏</code></td><td>玩家, 是否首次登录</td><td>玩家事件模块/玩家进入游戏事件.lua</td></tr>
<tr><td><code>玩家升级事件</code></td><td><code>处理玩家升级事件</code></td><td>玩家</td><td>玩家事件模块/玩家升级事件.lua</td></tr>
<tr><td><code>玩家死亡事件</code></td><td><code>处理玩家死亡事件</code></td><td>玩家, 击杀者, 技能击杀</td><td>玩家事件模块/玩家死亡事件.lua</td></tr>
<tr><td><code>玩家属性事件</code></td><td><code>处理玩家属性事件</code></td><td>玩家</td><td>玩家事件模块/玩家属性事件.lua</td></tr>
<tr><td><code>玩家执行事件</code></td><td><code>处理玩家执行事件</code></td><td>玩家</td><td>玩家事件模块/玩家执行事件.lua</td></tr>
<tr><td><code>玩家充值事件</code></td><td><code>处理玩家充值事件</code></td><td>玩家, 充值金额</td><td>玩家事件模块/玩家充值事件.lua</td></tr>
</tbody>
</table>

<h3>💬 玩家事件（交互类）</h3>
<table>
<thead><tr><th style='width:22%'>C# 调用的函数</th><th style='width:25%'>你要实现的函数</th><th style='width:25%'>参数</th><th style='width:28%'>脚本文件</th></tr></thead>
<tbody>
<tr><td><code>玩家对话NPC</code></td><td><code>处理玩家对话NPC</code></td><td>玩家, 守卫</td><td>玩家事件模块/玩家对话NPC事件.lua</td></tr>
<tr><td><code>玩家点击NPC</code></td><td><code>处理玩家点击NPC</code></td><td>玩家, 对诚NPC, 选项编号</td><td>玩家事件模块/玩家点击NPC事件.lua</td></tr>
<tr><td><code>玩家使用物品</code></td><td><code>处理玩家使用物品</code></td><td>玩家, 物品</td><td>玩家事件模块/物品使用事件.lua</td></tr>
<tr><td><code>玩家拾取事件</code></td><td><code>处理玩家拾取事件</code></td><td>玩家, 物品</td><td>玩家事件模块/背包事件.lua</td></tr>
</tbody>
</table>

<h3>⚔️ 玩家事件（装备养成）</h3>
<table>
<thead><tr><th style='width:22%'>C# 调用的函数</th><th style='width:25%'>你要实现的函数</th><th style='width:25%'>参数</th><th style='width:28%'>脚本文件</th></tr></thead>
<tbody>
<tr><td><code>玩家合成物品</code></td><td><code>处理玩家合成物品</code></td><td>玩家, 模板编号</td><td>玩家事件模块/玩家合成物品事件.lua</td></tr>
<tr><td><code>玩家合成装备</code></td><td><code>处理玩家合成装备</code></td><td>玩家, 合成勋章, 模板编号, 未知参数, 合成参数</td><td>玩家事件模块/玩家合成装备事件.lua</td></tr>
<tr><td><code>玩家重铸装备</code></td><td><code>处理玩家重铸装备</code></td><td>玩家, 部位, 未知</td><td>玩家事件模块/玩家重铸装备事件.lua</td></tr>
<tr><td><code>玩家重铸技能</code></td><td><code>处理玩家重铸技能</code></td><td>玩家</td><td>玩家事件模块/玩家重铸技能事件.lua</td></tr>
<tr><td><code>玩家装备精炼</code></td><td><code>处理玩家装备精炼</code></td><td>玩家, 背包类型, 背包位置</td><td>玩家事件模块/玩家装备精炼事件.lua</td></tr>
<tr><td><code>玩家装备分解</code></td><td><code>处理玩家装备分解</code></td><td>玩家, 背包类型, 物品位置, 分解数量</td><td>玩家事件模块/玩家装备分解事件.lua</td></tr>
<tr><td><code>玩家装备神佑</code></td><td><code>处理玩家装备神佑</code></td><td>玩家, 装备部位</td><td>玩家事件模块/玩家装备神佑事件.lua</td></tr>
<tr><td><code>玩家武器铸魂</code></td><td><code>处理玩家武器铸魂</code></td><td>玩家</td><td>玩家事件模块/玩家武器铸魂事件.lua</td></tr>
<tr><td><code>玩家武器升级</code></td><td><code>处理玩家武器升级</code></td><td>玩家</td><td>玩家事件模块/玩家武器升级事件.lua</td></tr>
<tr><td><code>玩家武器祈祷</code></td><td><code>处理玩家武器祈祷</code></td><td>玩家, 未知参数</td><td>玩家事件模块/玩家武器祈祷事件.lua</td></tr>
<tr><td><code>玩家防具升级</code></td><td><code>处理玩家防具升级</code></td><td>玩家, 装备部位</td><td>玩家事件模块/玩家防具升级事件.lua</td></tr>
<tr><td><code>玩家合无相石</code></td><td><code>处理玩家合无相石</code></td><td>玩家, 物品位置, 一键合成</td><td>玩家事件模块/玩家合无相石事件.lua</td></tr>
<tr><td><code>玩家勋章洗炼</code></td><td><code>处理玩家勋章洗炼</code></td><td>玩家, 勋章</td><td>玩家事件模块/玩家勋章洗炼事件.lua</td></tr>
<tr><td><code>玩家穿卸事件</code></td><td><code>处理玩家穿卸事件</code></td><td>玩家, 装备部位, 原有装备, 现有装备</td><td>玩家事件模块/玩家穿卸装备事件.lua</td></tr>
</tbody>
</table>

<h3>🗺️ 地图事件</h3>
<table>
<thead><tr><th style='width:22%'>C# 调用的函数</th><th style='width:25%'>你要实现的函数</th><th style='width:25%'>参数</th><th style='width:28%'>脚本文件</th></tr></thead>
<tbody>
<tr><td><code>地图创建事件</code></td><td><code>处理地图创建事件</code></td><td>地图</td><td>地图事件模块/地图创建事件.lua</td></tr>
<tr><td><code>地图执行事件</code></td><td><code>处理地图执行事件</code></td><td>地图</td><td>地图事件模块/地图执行事件.lua</td></tr>
<tr><td><code>地图进入事件</code></td><td><code>处理地图进入事件</code></td><td>地图, 玩家</td><td>地图事件模块/地图进入事件.lua</td></tr>
<tr><td><code>地图退出事件</code></td><td><code>处理地图退出事件</code></td><td>地图, 玩家</td><td>地图事件模块/地图退出事件.lua</td></tr>
<tr><td><code>地图销毁事件</code></td><td><code>处理地图销毁事件</code></td><td>地图</td><td>地图事件模块/地图销毁事件.lua</td></tr>
</tbody>
</table>

<h3>🛡️ 守卫（NPC）事件</h3>
<table>
<thead><tr><th style='width:22%'>C# 调用的函数</th><th style='width:25%'>你要实现的函数</th><th style='width:25%'>参数</th><th style='width:28%'>脚本文件</th></tr></thead>
<tbody>
<tr><td><code>守卫创建事件</code></td><td><code>处理守卫创建事件</code></td><td>守卫</td><td>守卫事件模块/守卫创建事件.lua</td></tr>
<tr><td><code>守卫执行事件</code></td><td><code>处理守卫执行事件</code></td><td>守卫</td><td>守卫事件模块/守卫执行事件.lua</td></tr>
<tr><td><code>守卫死亡事件</code></td><td><code>处理守卫死亡事件</code></td><td>守卫实例, 击杀者</td><td>守卫事件模块/守卫死亡事件.lua</td></tr>
<tr><td><code>守卫被攻击事件</code></td><td><code>处理守卫被攻击事件</code></td><td>守卫实例, 攻击者, 伤害值</td><td>守卫事件模块/守卫被攻击事件.lua</td></tr>
</tbody>
</table>

<h3>✨ BUFF 事件</h3>
<table>
<thead><tr><th style='width:22%'>C# 调用的函数</th><th style='width:25%'>你要实现的函数</th><th style='width:25%'>参数</th><th style='width:28%'>脚本文件</th></tr></thead>
<tbody>
<tr><td><code>执行触发BUFF</code></td><td><code>处理执行触发BUFF</code></td><td>玩家, 数据</td><td>BUFF事件模块/BUFF执行事件.lua</td></tr>
<tr><td><code>添加触发BUFF</code></td><td><code>处理添加触发BUFF</code></td><td>玩家, 数据</td><td>BUFF事件模块/BUFF添加事件.lua</td></tr>
<tr><td><code>移除触发BUFF</code></td><td><code>处理移除触发BUFF</code></td><td>玩家, 数据</td><td>BUFF事件模块/BUFF移除事件.lua</td></tr>
<tr><td><code>删除触发BUFF</code></td><td><code>处理删除触发BUFF</code></td><td>玩家, 数据</td><td>BUFF事件模块/BUFF删除事件.lua</td></tr>
</tbody>
</table>

<h3>👹 怪物事件</h3>
<table>
<thead><tr><th style='width:22%'>C# 调用的函数</th><th style='width:25%'>你要实现的函数</th><th style='width:25%'>参数</th><th style='width:28%'>脚本文件</th></tr></thead>
<tbody>
<tr><td><code>怪物死亡事件</code></td><td><code>处理怪物死亡事件</code></td><td>怪物, 击杀者, 技能击杀</td><td>怪物事件模块/怪物死亡事件.lua</td></tr>
</tbody>
</table>

<h3>🎁 奖励事件</h3>
<table>
<thead><tr><th style='width:22%'>C# 调用的函数</th><th style='width:25%'>你要实现的函数</th><th style='width:25%'>参数</th><th style='width:28%'>脚本文件</th></tr></thead>
<tbody>
<tr><td><code>月卡奖励领取</code></td><td><code>处理月卡奖励领取</code></td><td>玩家, 特权类型, 礼包位置</td><td>奖励事件模块/月卡奖励事件.lua</td></tr>
<tr><td><code>签到奖励领取</code></td><td><code>处理签到奖励领取</code></td><td>玩家, 类型, 位置</td><td>奖励事件模块/签到奖励事件.lua</td></tr>
<tr><td><code>特惠礼包事件</code></td><td><code>处理特惠礼包事件</code></td><td>玩家, 礼包编号</td><td>奖励事件模块/特惠礼包事件.lua</td></tr>
</tbody>
</table>

<h3>⚙️ 系统事件</h3>
<table>
<thead><tr><th style='width:22%'>C# 调用的函数</th><th style='width:25%'>你要实现的函数</th><th style='width:25%'>参数</th><th style='width:28%'>脚本文件</th></tr></thead>
<tbody>
<tr><td><code>每日清空事件</code></td><td><code>处理每日清空事件</code></td><td>玩家</td><td>系统事件模块/每日清空事件.lua</td></tr>
<tr><td><code>主动GC</code></td><td><code>处理主动GC</code></td><td>无</td><td>系统事件模块/GC事件.lua</td></tr>
<tr><td><code>调用Lua</code></td><td><code>处理调用Lua</code></td><td>对象, ...</td><td>系统事件模块/Lua调用事件.lua</td></tr>
</tbody>
</table>

<h2>📝 典型脚本示例</h2>

<h3>示例 1：玩家进入游戏事件</h3>
<pre>-- 文件: Database/System/lua/事件脚本/玩家事件模块/玩家进入游戏事件.lua

function 处理玩家进入游戏(玩家, 是否首次登录)
    if 玩家 == nil then
        return false
    end

    if 是否首次登录 then
        玩家:执行脚本命令("发送系统消息", "★ 欢迎来到游戏世界！★")
        玩家:执行脚本命令("发送全服公告", "欢迎新玩家【" .. 玩家.对象名字 .. "】加入游戏！", "false")
    else
        玩家:执行脚本命令("发送系统消息", "★ 欢迎回来，勇士！★")
    end

    return true  -- 建议始终返回布尔值
end</pre>

<h3>示例 2：怪物死亡事件（首杀奖励）</h3>
<pre>-- 文件: Database/System/lua/事件脚本/怪物事件模块/怪物死亡事件.lua

function 处理怪物死亡事件(怪物, 击杀者, 技能击杀)
    if 怪物 == nil or 击杀者 == nil then
        return false
    end

    -- 检测是否是 BOSS（假设模板编号 > 1000 是 BOSS）
    if 怪物.模板编号 > 1000 then
        -- 全服公告
        local 怪物名 = 怪物.对象名字 or "未知怪物"
        local 击杀者名 = 击杀者.对象名字 or "未知玩家"
        击杀者:执行脚本命令("发送全服公告", 击杀者名 .. " 击杀了 " .. 怪物名 .. "！", "true")
    end

    return true
end</pre>

<h2>📚 Lua 语法速成（5 分钟）</h2>

<h3>变量和条件判断</h3>
<pre>-- 声明变量（用 local）
local 名字 = "张三"       -- 字符串
local 等级 = 50           -- 数字
local 是否VIP = true      -- 布尔值

-- if 判断
if 等级 >= 50 then
    print("等级足够")
elseif 等级 >= 30 then
    print("等级一般")
else
    print("等级不足")
end</pre>

<h3>循环</h3>
<pre>-- for 循环
for i = 1, 10 do
    print("第 " .. i .. " 次")
end

-- 遍历表
local 列表 = {"屠龙", "麻痹戒指", "复活戒指"}
for 索引, 物品 in ipairs(列表) do
    print(索引, 物品)
end</pre>

<div class='warning-box'><strong>⚠️ Lua 注意事项</strong>
<ul>
<li>数组索引从 <code>1</code> 开始，不是 0</li>
<li>用 <code>local</code> 声明局部变量（推荐）</li>
<li>字符串拼接用 <code>..</code>（两个点）</li>
<li>空值是 <code>nil</code>，判断用 <code>if 变量 == nil then</code></li>
</ul>
</div>

<h2>� 内置工具函数</h2>

<p>在 <code>核心模块/工具函数.lua</code> 里提供了常用工具，脚本可直接调用：</p>

<table>
<thead><tr><th style='width:30%'>函数</th><th style='width:35%'>说明</th><th style='width:35%'>示例</th></tr></thead>
<tbody>
<tr><td><code>安全加载文件(路径)</code></td><td>带错误捕获的 dofile</td><td><code>安全加载文件("Database/System/lua/配置/xxx.lua")</code></td></tr>
<tr><td><code>系统日志(内容)</code></td><td>输出调试日志</td><td><code>系统日志("玩家进入游戏")</code></td></tr>
<tr><td><code>FormatNum(n)</code></td><td>数字转整数字符串</td><td><code>local s = FormatNum(12345.6)</code></td></tr>
<tr><td><code>深拷贝(表)</code></td><td>完整复制一个表</td><td><code>local 新表 = 深拷贝(原表)</code></td></tr>
<tr><td><code>合并表(目标, 源)</code></td><td>合并两个表</td><td><code>合并表(配置, 默认配置)</code></td></tr>
<tr><td><code>分割字符串(str, 分隔符)</code></td><td>按分隔符拆分字符串</td><td><code>local t = 分割字符串("a,b,c", ",")</code></td></tr>
<tr><td><code>去除空格(str)</code></td><td>去除首尾空白</td><td><code>local s = 去除空格("  hello  ")</code></td></tr>
</tbody>
</table>

<h2>💡 调试技巧</h2>

<pre>-- 1. 参数验证（建议始终检查 nil）
function 处理玩家进入游戏(玩家, 是否首次登录)
    if 玩家 == nil then
        系统日志("[错误] 玩家对象为nil")
        return false
    end
    -- 业务逻辑...
    return true
end

-- 2. 数值转换（获取变量时记得转）
local 积分 = tonumber(玩家:获取脚本变量("%G10")) or 0

-- 3. 错误保护（用 pcall 包裹可能出错的代码）
local 成功, 错误 = pcall(function()
    玩家:执行脚本命令("传送指定地图", 3, 330, 330, 0)
end)
if not 成功 then
    系统日志("[错误] " .. tostring(错误))
end</pre>

<h2>📂 Lua脚本文件结构</h2>
<div class='warning-box'><strong>⚠️ 重要：文件存放位置规范</strong>
<p>所有Lua脚本必须存放在正确的目录，否则服务器无法加载！</p></div>

<pre>Database/System/lua/
├── 主脚本.lua                -- 系统入口文件
├── 初始化.lua                -- 初始化配置
├── 事件脚本/                 -- 事件处理脚本
│   ├── 事件分发器.lua
│   ├── 玩家事件模块/
│   │   ├── 玩家进入游戏事件.lua
│   │   ├── 玩家升级事件.lua
│   │   └── ...
│   └── 怪物事件模块/
│       └── 怪物死亡事件.lua
├── Npc/                     -- NPC相关脚本
│   └── Npc脚本/             -- ⭐ NPC脚本存放目录
│       ├── 6100.lua         -- NPC编号.lua
│       └── ...
└── 地图/                    -- 地图相关脚本</pre>

<h2>🎓 学习建议</h2>
<div class='feature-grid'>
<div class='feature-card'><h4>📖 循序渐进</h4>
<p>1. 先看"核心 API"学会调用命令<br>2. 查"事件函数清单"找要改的事件<br>3. 复制示例代码改一改<br>4. 用<code>系统日志()</code>调试</p></div>
<div class='feature-card'><h4>🐛 常见问题</h4>
<p>1. 命令不生效 → 检查命令名拼写<br>2. 报 nil 错 → 加参数有效性检查<br>3. 没有反应 → 用<code>系统日志</code>定位</p></div>
<div class='feature-card'><h4>💡 最佳实践</h4>
<p>1. 用 <code>local</code> 声明变量<br>2. 事件函数始终 <code>return</code> 布尔值<br>3. 用中文命名，便于理解<br>4. 复杂逻辑拆成小函数</p></div>
<div class='feature-card'><h4>📚 参考资源</h4>
<p>1. 现有事件脚本是最好的例子<br>2. TXT 脚本命令文档<br>3. 测试服验证后再上线</p></div>
</div>

<div class='success-box'><strong>✅ 快速入门总结</strong>
<p>记住这三步：</p>
<ul>
<li>1️⃣ <strong>找事件</strong> → 查"事件函数清单"，找到你要改的事件和对应文件</li>
<li>2️⃣ <strong>写逻辑</strong> → 实现 <code>处理XXX事件</code> 函数，用 <code>玩家:执行脚本命令</code> 调用 TXT 命令</li>
<li>3️⃣ <strong>调试</strong> → 用 <code>系统日志("...")</code> 输出，看服务器日志排查问题</li>
</ul>
<p><strong>接下来：</strong>打开 <code>事件脚本/玩家事件模块/玩家进入游戏事件.lua</code>，照着示例改一个欢迎消息试试！</p></div>
</body></html>
